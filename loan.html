<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>æ›¸ç±è²¸å‡º</title>
  <?!= include('mobile-common-styles'); ?>
  <style>
    /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .mobile-content {
      padding-top: 56px;
      padding-bottom: 180px;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ä¿®æ­£ */
    .mobile-header .back-button {
      position: relative;
      z-index: 10;
      background-color: transparent;
      border: 2px solid #1976d2;
      color: #1976d2;
      font-size: 24px;
      font-weight: bold;
      min-width: 40px;
      height: 40px;
    }
    
    .mobile-header .back-button:hover {
      background-color: #e3f2fd;
    }
    
    /* ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .step-indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background-color: #f8f9fa;
      margin-bottom: 16px;
    }
    
    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }
    
    .step::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background-color: #e0e0e0;
    }
    
    .step:last-child::after {
      display: none;
    }
    
    .step.active::after {
      background-color: #1976d2;
    }
    
    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }
    
    .step.active .step-number {
      background-color: #1976d2;
      color: white;
    }
    
    .step.completed .step-number {
      background-color: #4caf50;
      color: white;
    }
    
    .step-label {
      font-size: 12px;
      color: #666;
    }
    
    .step.active .step-label {
      color: #1976d2;
      font-weight: 600;
    }
    
    /* ã‚¹ã‚­ãƒ£ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .scan-section {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    .scan-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .scan-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    
    .scan-status {
      font-size: 14px;
      padding: 4px 12px;
      border-radius: 16px;
      background-color: #e0e0e0;
      color: #666;
    }
    
    .scan-status.success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .scan-input-wrapper {
      position: relative;
      margin-bottom: 12px;
    }
    
    .scan-button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    input.with-scan-button {
      padding-right: 120px;
    }
    
    /* ç¢ºèªæƒ…å ±è¡¨ç¤º */
    .info-card {
      background-color: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-size: 14px;
      color: #666;
    }
    
    .info-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    /* è²¸å‡ºæœŸé™è¡¨ç¤º */
    .due-date-card {
      background-color: #fff3e0;
      border: 1px solid #ffb74d;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .due-date-label {
      font-size: 14px;
      color: #e65100;
      margin-bottom: 4px;
    }
    
    .due-date-value {
      font-size: 20px;
      font-weight: 600;
      color: #e65100;
    }
    
    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background-color: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« - book-register.htmlã‹ã‚‰æµç”¨ */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }
    
    .sidebar-container {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background-color: #ffffff;
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    
    .sidebar-container.active {
      right: 0;
    }
    
    .sidebar-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      z-index: 1001;
    }
    
    .sidebar-content {
      padding-top: 72px;
      padding-bottom: 20px;
    }
    
    .scanner-viewport {
      position: relative;
      width: 100%;
      height: 50vh;
      background-color: #000;
      overflow: hidden;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 40%;
      border: 3px solid #4caf50;
      border-radius: 8px;
      box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      z-index: 10;
    }
    
    .scanner-instructions {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 8px 16px;
      border-radius: 20px;
      text-align: center;
      font-size: 14px;
      z-index: 10;
    }
    
    .manual-input-section {
      background-color: #f8f9fa;
      padding: 16px;
      margin: 16px;
      border-radius: 12px;
    }
    
    .manual-input-section h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .scanner-controls {
      display: flex;
      gap: 12px;
      padding: 16px;
    }
    
    .scan-result {
      background-color: #4caf50;
      color: white;
      padding: 12px;
      margin: 16px;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    
    /* éè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .hidden {
      display: none;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="mobile-header" style="display: flex; align-items: center; justify-content: flex-start;">
    <button class="back-button" onclick="navigateTo('menu')" style="display: block; visibility: visible;">
      â†
    </button>
    <h1 style="flex: 1; text-align: center; margin-right: 48px;">æ›¸ç±è²¸å‡º</h1>
  </div>
  
  <div class="mobile-content">
    <div id="message" class="toast" style="display: none;"></div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div class="step-indicator">
      <div class="step active" id="step1">
        <div class="step-number">1</div>
        <div class="step-label">åˆ©ç”¨è€…</div>
      </div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <div class="step-label">æ›¸ç±</div>
      </div>
      <div class="step" id="step3">
        <div class="step-number">3</div>
        <div class="step-label">ç¢ºèª</div>
      </div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: åˆ©ç”¨è€…é¸æŠ -->
    <div id="userSection" class="scan-section">
      <div class="scan-header">
        <div class="scan-title">åˆ©ç”¨è€…ã‚«ãƒ¼ãƒ‰</div>
        <div class="scan-status" id="userStatus">æœªã‚¹ã‚­ãƒ£ãƒ³</div>
      </div>
      <div class="form-group">
        <label for="userId">åˆ©ç”¨è€…ID / ã‚«ãƒ¼ãƒ‰ç•ªå·</label>
        <div class="scan-input-wrapper">
          <input type="text" id="userId" class="with-scan-button" placeholder="U0001 ã¾ãŸã¯ ã‚«ãƒ¼ãƒ‰ç•ªå·">
          <button type="button" class="scan-button" onclick="openBarcodeScanner('user')">
            ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³
          </button>
        </div>
        <button class="btn btn-primary" onclick="verifyUser()" style="width: 100%;">åˆ©ç”¨è€…ç¢ºèª</button>
      </div>
      
      <!-- åˆ©ç”¨è€…æƒ…å ±è¡¨ç¤º -->
      <div id="userInfo" class="info-card hidden">
        <div class="info-row">
          <span class="info-label">æ°å</span>
          <span class="info-value" id="userName">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">ã‚«ãƒ¼ãƒ‰ç•ªå·</span>
          <span class="info-value" id="userCardNumber">-</span>
        </div>
      </div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: æ›¸ç±é¸æŠ -->
    <div id="bookSection" class="scan-section hidden">
      <div class="scan-header">
        <div class="scan-title">æ›¸ç±ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</div>
        <div class="scan-status" id="bookStatus">æœªã‚¹ã‚­ãƒ£ãƒ³</div>
      </div>
      <div class="form-group">
        <label for="bookId">æ›¸ç±ID / ISBN</label>
        <div class="scan-input-wrapper">
          <input type="text" id="bookId" class="with-scan-button" placeholder="B0001 ã¾ãŸã¯ ISBN">
          <button type="button" class="scan-button" onclick="openBarcodeScanner('book')">
            ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³
          </button>
        </div>
        <button class="btn btn-primary" onclick="verifyBook()" style="width: 100%;">æ›¸ç±ç¢ºèª</button>
      </div>
      
      <!-- æ›¸ç±æƒ…å ±è¡¨ç¤º -->
      <div id="bookInfo" class="info-card hidden">
        <div class="info-row">
          <span class="info-label">æ›¸ç±å</span>
          <span class="info-value" id="bookTitle">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">è‘—è€…</span>
          <span class="info-value" id="bookAuthor">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">çŠ¶æ…‹</span>
          <span class="info-value" id="bookStatusValue">-</span>
        </div>
      </div>
      
      <button class="btn btn-success" onclick="addMoreBooks()" style="width: 100%; margin-top: 12px;">
        + åˆ¥ã®æ›¸ç±ã‚’è¿½åŠ 
      </button>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ç¢ºèªç”»é¢ -->
    <div id="confirmSection" class="hidden">
      <div class="card">
        <h3 style="margin-bottom: 16px;">è²¸å‡ºå†…å®¹ã®ç¢ºèª</h3>
        
        <!-- åˆ©ç”¨è€…æƒ…å ± -->
        <div class="info-card">
          <h4 style="font-size: 14px; color: #666; margin-bottom: 12px;">åˆ©ç”¨è€…æƒ…å ±</h4>
          <div class="info-row">
            <span class="info-label">æ°å</span>
            <span class="info-value" id="confirmUserName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">åˆ©ç”¨è€…ID</span>
            <span class="info-value" id="confirmUserId">-</span>
          </div>
        </div>
        
        <!-- è²¸å‡ºæ›¸ç±ãƒªã‚¹ãƒˆ -->
        <div class="info-card">
          <h4 style="font-size: 14px; color: #666; margin-bottom: 12px;">è²¸å‡ºæ›¸ç±</h4>
          <div id="confirmBookList"></div>
        </div>
        
        <!-- è¿”å´æœŸé™ -->
        <div class="due-date-card">
          <div class="due-date-label">è¿”å´æœŸé™</div>
          <div class="due-date-value" id="dueDate">-</div>
        </div>
      </div>
    </div>
    
    <!-- å›ºå®šãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— -->
    <div class="button-group">
      <button id="nextButton" class="btn btn-primary" onclick="nextStep()" style="display: none;">
        æ¬¡ã¸é€²ã‚€
      </button>
      <button id="loanButton" class="btn btn-success" onclick="executeLoan()" style="display: none;">
        è²¸å‡ºã‚’å®Ÿè¡Œã™ã‚‹
      </button>
      <button class="btn btn-secondary" onclick="cancelLoan()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-secondary" onclick="navigateTo('menu')">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
    </div>
  </div>
  
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼‰ -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <div class="sidebar-container" id="sidebarContainer">
    <div class="sidebar-header">
      <h3 id="sidebarTitle">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h3>
      <button class="back-button" onclick="closeSidebar()">Ã—</button>
    </div>
    <div class="sidebar-content">
      <div class="scanner-viewport" id="interactive">
        <div class="scanner-overlay"></div>
        <div class="scanner-instructions" id="scannerInstructions">
          ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç·‘ã®æ å†…ã«åã‚ã¦ãã ã•ã„
        </div>
      </div>
      
      <div id="sidebar-message" class="toast" style="display: none;"></div>
      
      <div id="scan-result" class="scan-result"></div>
      
      <div class="scanner-controls">
        <button class="btn btn-primary" id="scanButton" onclick="toggleScanner()" style="flex: 1;">ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
      </div>
      
      <div class="manual-input-section">
        <h4 id="manualInputTitle">ç•ªå·ã‚’æ‰‹å‹•å…¥åŠ›</h4>
        <input type="text" id="manual-code-sidebar" placeholder="">
        <button class="btn btn-success" onclick="submitManualInput()" style="width: 100%; margin-top: 12px;">ç¢ºå®š</button>
      </div>
    </div>
  </div>
  
  <?!= include('common-scripts'); ?>
  <!-- ZXing ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨ï¼‰ -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let codeReader = null;
    let isShowingCamera = false;
    let currentScanType = '';
    let currentStep = 1;
    let loanData = {
      userId: '',
      userName: '',
      userCardNumber: '',
      books: []
    };
    
    // ã‚¹ãƒ†ãƒƒãƒ—åˆ¶å¾¡
    function updateStepIndicator(step) {
      // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active', 'completed');
      });
      
      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã¾ã§ã‚’æ›´æ–°
      for (let i = 1; i <= step; i++) {
        const stepEl = document.getElementById('step' + i);
        if (i < step) {
          stepEl.classList.add('completed');
        } else if (i === step) {
          stepEl.classList.add('active');
        }
      }
    }
    
    // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
    function nextStep() {
      if (currentStep === 1 && loanData.userId) {
        currentStep = 2;
        updateStepIndicator(2);
        document.getElementById('userSection').classList.add('hidden');
        document.getElementById('bookSection').classList.remove('hidden');
        document.getElementById('nextButton').style.display = 'none';
      } else if (currentStep === 2 && loanData.books.length > 0) {
        showConfirmation();
      }
    }
    
    // åˆ©ç”¨è€…ç¢ºèª
    function verifyUser() {
      const userIdInput = document.getElementById('userId').value;
      if (!userIdInput) {
        showMessage('åˆ©ç”¨è€…IDã¾ãŸã¯ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showMessage('åˆ©ç”¨è€…æƒ…å ±ã‚’ç¢ºèªä¸­...', 'info');
      
      google.script.run
        .withSuccessHandler(function(users) {
          if (users && users.length > 0) {
            const user = users[0];
            loanData.userId = user.userId;
            loanData.userName = user.userName;
            loanData.userCardNumber = user.cardNumber;
            
            // åˆ©ç”¨è€…æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('userName').textContent = user.userName;
            document.getElementById('userCardNumber').textContent = user.cardNumber;
            document.getElementById('userInfo').classList.remove('hidden');
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            const userStatus = document.getElementById('userStatus');
            userStatus.textContent = 'ç¢ºèªæ¸ˆã¿';
            userStatus.classList.add('success');
            
            // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('nextButton').style.display = 'block';
            
            showMessage('åˆ©ç”¨è€…ã‚’ç¢ºèªã—ã¾ã—ãŸ', 'success');
          } else {
            showMessage('åˆ©ç”¨è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('åˆ©ç”¨è€…ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
          showMessage('åˆ©ç”¨è€…ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .searchUsers({ userId: userIdInput });
    }
    
    // æ›¸ç±ç¢ºèª
    function verifyBook() {
      const bookIdInput = document.getElementById('bookId').value;
      if (!bookIdInput) {
        showMessage('æ›¸ç±IDã¾ãŸã¯ISBNã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showMessage('æ›¸ç±æƒ…å ±ã‚’ç¢ºèªä¸­...', 'info');
      
      google.script.run
        .withSuccessHandler(function(book) {
          if (book) {
            // è²¸å‡ºå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if (book.status !== 'åˆ©ç”¨å¯èƒ½') {
              showMessage('ã“ã®æ›¸ç±ã¯ç¾åœ¨è²¸å‡ºã§ãã¾ã›ã‚“ï¼ˆ' + book.status + 'ï¼‰', 'error');
              return;
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (loanData.books.some(b => b.bookId === book.bookId)) {
              showMessage('ã“ã®æ›¸ç±ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™', 'warning');
              return;
            }
            
            // æ›¸ç±æƒ…å ±ã‚’è¿½åŠ 
            loanData.books.push({
              bookId: book.bookId,
              title: book.title,
              author: book.author
            });
            
            // æ›¸ç±æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('bookTitle').textContent = book.title;
            document.getElementById('bookAuthor').textContent = book.author;
            document.getElementById('bookStatusValue').textContent = book.status;
            document.getElementById('bookInfo').classList.remove('hidden');
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            const bookStatus = document.getElementById('bookStatus');
            bookStatus.textContent = 'ç¢ºèªæ¸ˆã¿';
            bookStatus.classList.add('success');
            
            // è²¸å‡ºãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            if (loanData.books.length > 0) {
              document.getElementById('nextButton').style.display = 'block';
              document.getElementById('nextButton').textContent = 'ç¢ºèªç”»é¢ã¸';
            }
            
            showMessage('æ›¸ç±ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('bookId').value = '';
          } else {
            showMessage('æ›¸ç±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('æ›¸ç±ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
          showMessage('æ›¸ç±ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .getBookDetails(bookIdInput);
    }
    
    // åˆ¥ã®æ›¸ç±ã‚’è¿½åŠ 
    function addMoreBooks() {
      // æ›¸ç±æƒ…å ±è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('bookInfo').classList.add('hidden');
      document.getElementById('bookId').value = '';
      document.getElementById('bookId').focus();
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      const bookStatus = document.getElementById('bookStatus');
      bookStatus.textContent = 'æœªã‚¹ã‚­ãƒ£ãƒ³';
      bookStatus.classList.remove('success');
    }
    
    // ç¢ºèªç”»é¢è¡¨ç¤º
    function showConfirmation() {
      currentStep = 3;
      updateStepIndicator(3);
      
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('bookSection').classList.add('hidden');
      document.getElementById('confirmSection').classList.remove('hidden');
      
      // åˆ©ç”¨è€…æƒ…å ±è¨­å®š
      document.getElementById('confirmUserName').textContent = loanData.userName;
      document.getElementById('confirmUserId').textContent = loanData.userId;
      
      // æ›¸ç±ãƒªã‚¹ãƒˆè¡¨ç¤º
      const bookList = document.getElementById('confirmBookList');
      bookList.innerHTML = '';
      loanData.books.forEach((book, index) => {
        const bookRow = document.createElement('div');
        bookRow.className = 'info-row';
        bookRow.innerHTML = `
          <span class="info-label">${index + 1}. ${book.title}</span>
          <span class="info-value">${book.bookId}</span>
        `;
        bookList.appendChild(bookRow);
      });
      
      // è¿”å´æœŸé™è¨ˆç®—ï¼ˆ14æ—¥å¾Œï¼‰
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 14);
      const dueDateStr = dueDate.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      document.getElementById('dueDate').textContent = dueDateStr;
      
      // ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('nextButton').style.display = 'none';
      document.getElementById('loanButton').style.display = 'block';
    }
    
    // è²¸å‡ºå®Ÿè¡Œ
    function executeLoan() {
      if (!loanData.userId || loanData.books.length === 0) {
        showMessage('è²¸å‡ºæƒ…å ±ãŒä¸å®Œå…¨ã§ã™', 'error');
        return;
      }
      
      showMessage('è²¸å‡ºå‡¦ç†ã‚’å®Ÿè¡Œä¸­...', 'info');
      document.getElementById('loanButton').disabled = true;
      
      const loanRequestData = {
        userId: loanData.userId,
        bookIds: loanData.books.map(b => b.bookId)
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('è²¸å‡ºå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            
            // 3ç§’å¾Œã«ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
            setTimeout(() => {
              navigateTo('menu');
            }, 3000);
          } else {
            document.getElementById('loanButton').disabled = false;
            showMessage(result.message || 'è²¸å‡ºå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('loanButton').disabled = false;
          console.error('è²¸å‡ºå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
          showMessage('è²¸å‡ºå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .executeLoan(loanRequestData);
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelLoan() {
      if (confirm('è²¸å‡ºå‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
        navigateTo('menu');
      }
    }
    
    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’é–‹ã
    function openBarcodeScanner(type) {
      currentScanType = type;
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¨­å®š
      if (type === 'user') {
        document.getElementById('sidebarTitle').textContent = 'åˆ©ç”¨è€…ã‚«ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³';
        document.getElementById('scannerInstructions').textContent = 'åˆ©ç”¨è€…ã‚«ãƒ¼ãƒ‰ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
        document.getElementById('manualInputTitle').textContent = 'ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’æ‰‹å‹•å…¥åŠ›';
        document.getElementById('manual-code-sidebar').placeholder = 'ä¾‹: U0001';
      } else {
        document.getElementById('sidebarTitle').textContent = 'æ›¸ç±ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³';
        document.getElementById('scannerInstructions').textContent = 'æ›¸ç±ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
        document.getElementById('manualInputTitle').textContent = 'ISBN/æ›¸ç±IDã‚’æ‰‹å‹•å…¥åŠ›';
        document.getElementById('manual-code-sidebar').placeholder = 'ä¾‹: 9784123456789';
      }
      
      document.getElementById('sidebarOverlay').style.display = 'block';
      document.getElementById('sidebarContainer').classList.add('active');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
      setTimeout(() => {
        startCameraPreview();
      }, 300);
    }
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
    function closeSidebar() {
      document.getElementById('sidebarOverlay').style.display = 'none';
      document.getElementById('sidebarContainer').classList.remove('active');
      
      // ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
      stopCameraPreview();
    }
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function setSidebarMessage(text, type = 'info') {
      const messageEl = document.getElementById('sidebar-message');
      messageEl.textContent = text;
      messageEl.className = 'toast ' + type;
      messageEl.style.display = 'block';
      messageEl.style.position = 'fixed';
      messageEl.style.bottom = '80px';
      messageEl.style.left = '50%';
      messageEl.style.transform = 'translateX(-50%)';
      messageEl.style.zIndex = '200';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    }
    
    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é–‹å§‹/åœæ­¢åˆ‡ã‚Šæ›¿ãˆ
    function toggleScanner() {
      if (isShowingCamera) {
        stopCameraPreview();
      } else {
        startCameraPreview();
      }
    }
    
    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹
    async function startCameraPreview() {
      try {
        // ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆ
        let videoElement = document.querySelector('#interactive video');
        if (!videoElement) {
          videoElement = document.createElement('video');
          videoElement.id = 'barcode-video';
          videoElement.style.width = '100%';
          videoElement.style.height = '100%';
          videoElement.style.objectFit = 'cover';
          document.getElementById('interactive').appendChild(videoElement);
        }
        
        // ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆæœŸåŒ–
        const { BrowserMultiFormatReader } = window.ZXing;
        codeReader = new BrowserMultiFormatReader();
        
        // åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
        const videoInputDevices = await codeReader.listVideoInputDevices();
        
        // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
        const selectedDeviceId = videoInputDevices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear')
        )?.deviceId || videoInputDevices[0]?.deviceId;
        
        if (!selectedDeviceId) {
          throw new Error('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        // ç¶™ç¶šçš„ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹
        await codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err) => {
          if (result) {
            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œå‡ºæˆåŠŸ
            handleBarcodeDetected(result.text);
          }
          if (err && !(err.name === 'NotFoundException')) {
            console.error('ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
          }
        });
        
        isShowingCamera = true;
        
        // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        const scanButton = document.getElementById('scanButton');
        scanButton.textContent = 'ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢';
        scanButton.classList.remove('btn-primary');
        scanButton.classList.add('btn-warning');
        
        setSidebarMessage('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„', 'info');
        
      } catch (err) {
        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
        setSidebarMessage('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error');
      }
    }
    
    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åœæ­¢
    function stopCameraPreview() {
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      
      const videoElement = document.querySelector('#interactive video');
      if (videoElement) {
        videoElement.remove();
      }
      
      isShowingCamera = false;
      
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      const scanButton = document.getElementById('scanButton');
      scanButton.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹';
      scanButton.classList.remove('btn-warning');
      scanButton.classList.add('btn-primary');
      
      // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ã‚¯ãƒªã‚¢
      const scanResult = document.getElementById('scan-result');
      scanResult.style.display = 'none';
      scanResult.textContent = '';
    }
    
    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œå‡ºæ™‚ã®å‡¦ç†
    function handleBarcodeDetected(code) {
      // ãƒ“ãƒ¼ãƒ—éŸ³ã‚’å†ç”Ÿ
      playBeepSound();
      
      // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’è¡¨ç¤º
      const scanResult = document.getElementById('scan-result');
      scanResult.textContent = 'âœ“ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º: ' + code;
      scanResult.style.display = 'block';
      
      // å¯¾å¿œã™ã‚‹å…¥åŠ›æ¬„ã«å€¤ã‚’è¨­å®š
      if (currentScanType === 'user') {
        document.getElementById('userId').value = code;
      } else {
        document.getElementById('bookId').value = code;
      }
      
      // 1ç§’å¾Œã«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      setTimeout(() => {
        closeSidebar();
        showMessage('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ', 'success');
      }, 1000);
    }
    
    // ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿ
    function playBeepSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1000;
        gainNode.gain.value = 0.3;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        console.error("ãƒ“ãƒ¼ãƒ—éŸ³ã®å†ç”Ÿã«å¤±æ•—:", e);
      }
    }
    
    // æ‰‹å‹•å…¥åŠ›ã®ç¢ºå®š
    function submitManualInput() {
      const code = document.getElementById('manual-code-sidebar').value;
      if (!code) {
        setSidebarMessage('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // å¯¾å¿œã™ã‚‹å…¥åŠ›æ¬„ã«å€¤ã‚’è¨­å®š
      if (currentScanType === 'user') {
        document.getElementById('userId').value = code;
      } else {
        document.getElementById('bookId').value = code;
      }
      
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      closeSidebar();
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      showMessage('ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
    }
    
    // Enterã‚­ãƒ¼ã§æ‰‹å‹•å…¥åŠ›ã‚’ç¢ºå®š
    document.addEventListener('DOMContentLoaded', function() {
      const manualInput = document.getElementById('manual-code-sidebar');
      if (manualInput) {
        manualInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            submitManualInput();
          }
        });
      }
    });
    
    // navigateToé–¢æ•°
    function navigateTo(page) {
      google.script.run
        .withSuccessHandler(function(url) {
          window.top.location.href = url + '?page=' + page;
        })
        .getDeployedUrl();
    }
  </script>
</body>
</html>