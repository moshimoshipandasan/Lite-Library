<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>æ›¸ç±ç™»éŒ²</title>
  <?!= include('mobile-common-styles'); ?>
  <style>
    /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .mobile-content {
      padding-top: 56px;
      padding-bottom: 160px;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ä¿®æ­£ */
    .mobile-header .back-button {
      position: relative;
      z-index: 10;
      background-color: transparent;
      border: 2px solid #1976d2;
      color: #1976d2;
      font-size: 24px;
      font-weight: bold;
      min-width: 40px;
      height: 40px;
    }
    
    .mobile-header .back-button:hover {
      background-color: #e3f2fd;
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
    .form-section {
      background-color: #ffffff;
      margin: 0;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }
    
    .form-section h2 {
      font-size: 18px;
      font-weight: 600;
      padding: 16px;
      margin: 0;
      background-color: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }
    
    /* ISBNå…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .isbn-section {
      padding: 16px;
    }
    
    .isbn-input-wrapper {
      position: relative;
      margin-bottom: 12px;
    }
    
    .isbn-scan-button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    input#isbn {
      padding-right: 120px;
    }
    
    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background-color: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
    }
    
    /* ãƒ’ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */
    .hint-card {
      background-color: #e3f2fd;
      border-radius: 12px;
      padding: 12px;
      margin: 12px 16px;
      font-size: 13px;
    }
    
    .hint-card-title {
      font-weight: 600;
      color: #1565c0;
      margin-bottom: 4px;
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }
    
    .sidebar-container {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background-color: #ffffff;
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    
    .sidebar-container.active {
      right: 0;
    }
    
    .sidebar-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      z-index: 1001;
    }
    
    .sidebar-content {
      padding-top: 72px;
      padding-bottom: 20px;
    }
    
    .scanner-viewport {
      position: relative;
      width: 100%;
      height: 50vh;
      background-color: #000;
      overflow: hidden;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 40%;
      border: 3px solid #4caf50;
      border-radius: 8px;
      box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      z-index: 10;
    }
    
    .scanner-instructions {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 8px 16px;
      border-radius: 20px;
      text-align: center;
      font-size: 14px;
      z-index: 10;
    }
    
    .manual-input-section {
      background-color: #f8f9fa;
      padding: 16px;
      margin: 16px;
      border-radius: 12px;
    }
    
    .manual-input-section h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .scanner-controls {
      display: flex;
      gap: 12px;
      padding: 16px;
    }
    
    /* ã‚«ãƒ¡ãƒ©æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”»é¢ */
    .camera-permission {
      text-align: center;
      padding: 40px 20px;
    }
    
    .camera-permission-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .camera-permission-text {
      font-size: 16px;
      color: #666;
      margin-bottom: 24px;
    }
    
    /* ã‚¹ã‚­ãƒ£ãƒ³çµæœè¡¨ç¤º */
    .scan-result {
      background-color: #4caf50;
      color: white;
      padding: 12px;
      margin: 16px;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="mobile-header" style="display: flex; align-items: center; justify-content: flex-start;">
    <button class="back-button" onclick="navigateTo('menu')" style="display: block; visibility: visible;">
      â†
    </button>
    <h1 style="flex: 1; text-align: center; margin-right: 48px;">æ›¸ç±ç™»éŒ²</h1>
  </div>
  
  <div class="mobile-content">
    <div id="message" class="toast" style="display: none;"></div>
    
    <!-- ISBNæ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card">
      <div class="form-group">
        <label for="isbn">ISBNã‚³ãƒ¼ãƒ‰</label>
        <div class="isbn-input-wrapper">
          <input type="text" id="isbn" placeholder="ä¾‹: 9784123456789">
          <button type="button" class="isbn-scan-button" onclick="openBarcodeScanner()">
            ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³
          </button>
        </div>
        <button class="btn btn-primary" onclick="searchByISBN()">ISBNæ¤œç´¢</button>
      </div>
    </div>
    
    <!-- ãƒ’ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ -->
    <div class="hint-card">
      <div class="hint-card-title">ğŸ’¡ ISBNå…¥åŠ›ã®ãƒ’ãƒ³ãƒˆ</div>
      <div>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®ä¸‹ã®æ•°å­—ã‚’ãƒã‚¤ãƒ•ãƒ³ãªã—ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    </div>
    
    <!-- æ›¸ç±æƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="bookForm">
      <div class="form-section">
        <h2>æ›¸ç±æƒ…å ±</h2>
        <div style="padding: 16px;">
          <div class="form-group">
            <label for="title">æ›¸ç±å *</label>
            <input type="text" id="title" required>
          </div>
          
          <div class="form-group">
            <label for="titleKana">æ›¸ç±åãƒ¨ãƒŸ</label>
            <input type="text" id="titleKana" placeholder="ã²ã‚‰ãŒãª ã¾ãŸã¯ ã‚«ã‚¿ã‚«ãƒŠ">
          </div>
          
          <div class="form-group">
            <label for="author">è‘—è€… *</label>
            <input type="text" id="author" required>
          </div>
          
          <div class="form-group">
            <label for="authorKana">è‘—è€…ãƒ¨ãƒŸ</label>
            <input type="text" id="authorKana" placeholder="ã²ã‚‰ãŒãª ã¾ãŸã¯ ã‚«ã‚¿ã‚«ãƒŠ">
          </div>
          
          <div class="form-group">
            <label for="publisher">å‡ºç‰ˆç¤¾ *</label>
            <input type="text" id="publisher" required>
          </div>
          
          <div class="form-group">
            <label for="publishYear">ç™ºè¡Œå¹´</label>
            <input type="number" id="publishYear" min="1900" max="2100" placeholder="ä¾‹: 2024">
          </div>
          
          <div class="form-group">
            <label for="price">ä¾¡æ ¼</label>
            <input type="number" id="price" min="0" placeholder="ä¾‹: 1500">
          </div>
          
          <div class="form-group">
            <label for="category">ã‚«ãƒ†ã‚´ãƒª</label>
            <input type="text" id="category" placeholder="ä¾‹: å°èª¬ã€ãƒ“ã‚¸ãƒã‚¹æ›¸">
          </div>
          
          <div class="form-group">
            <label for="location">æ‰€åœ¨å ´æ‰€</label>
            <input type="text" id="location" placeholder="ä¾‹: A-1-1">
          </div>
        </div>
      </div>
      
      <!-- å›ºå®šãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— -->
      <div class="button-group">
        <button type="submit" class="btn btn-primary">æ›¸ç±ã‚’ç™»éŒ²ã™ã‚‹</button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()">å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢</button>
        <button type="button" class="btn btn-secondary" onclick="navigateTo('menu')">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
      </div>
    </form>
  </div>
  
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼‰ -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <div class="sidebar-container" id="sidebarContainer">
    <div class="sidebar-header">
      <h3>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h3>
      <button class="back-button" onclick="closeSidebar()">Ã—</button>
    </div>
    <div class="sidebar-content">
      <div class="scanner-viewport" id="interactive">
        <div class="scanner-overlay"></div>
        <div class="scanner-instructions">
          ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç·‘ã®æ å†…ã«åã‚ã¦ãã ã•ã„
        </div>
      </div>
      
      <div id="sidebar-message" class="toast" style="display: none;"></div>
      
      <div id="scan-result" class="scan-result"></div>
      
      <div class="scanner-controls">
        <button class="btn btn-primary" id="scanButton" onclick="toggleScanner()" style="flex: 1;">ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
      </div>
      
      <div class="manual-input-section">
        <h4>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·ã‚’æ‰‹å‹•å…¥åŠ›</h4>
        <input type="text" id="manual-isbn-sidebar" placeholder="ä¾‹: 9784123456789">
        <button class="btn btn-success" onclick="submitManualInputFromSidebar()" style="width: 100%; margin-top: 12px;">ç¢ºå®š</button>
      </div>
    </div>
  </div>
  
  <?!= include('common-scripts'); ?>
  <!-- ZXing ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨ï¼‰ -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let codeReader = null;
    let isShowingCamera = false;
    let selectedDeviceId = null;
    let scanInterval = null;
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‹ã
    function openBarcodeScanner() {
      document.getElementById('sidebarOverlay').style.display = 'block';
      document.getElementById('sidebarContainer').classList.add('active');
      
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
      setTimeout(() => {
        startCameraPreview();
      }, 300);
    }
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
    function closeSidebar() {
      document.getElementById('sidebarOverlay').style.display = 'none';
      document.getElementById('sidebarContainer').classList.remove('active');
      
      // ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
      stopCameraPreview();
    }
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function setSidebarMessage(text, type = 'info') {
      const messageEl = document.getElementById('sidebar-message');
      messageEl.textContent = text;
      messageEl.className = 'toast ' + type;
      messageEl.style.display = 'block';
      messageEl.style.position = 'fixed';
      messageEl.style.bottom = '80px';
      messageEl.style.left = '50%';
      messageEl.style.transform = 'translateX(-50%)';
      messageEl.style.zIndex = '200';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    }
    
    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é–‹å§‹/åœæ­¢åˆ‡ã‚Šæ›¿ãˆ
    function toggleScanner() {
      if (isShowingCamera) {
        stopCameraPreview();
      } else {
        startCameraPreview();
      }
    }
    
    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹
    async function startCameraPreview() {
      try {
        // ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆ
        let videoElement = document.querySelector('#interactive video');
        if (!videoElement) {
          videoElement = document.createElement('video');
          videoElement.id = 'barcode-video';
          videoElement.style.width = '100%';
          videoElement.style.height = '100%';
          videoElement.style.objectFit = 'cover';
          document.getElementById('interactive').appendChild(videoElement);
        }
        
        // ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆæœŸåŒ–
        const { BrowserMultiFormatReader } = window.ZXing;
        codeReader = new BrowserMultiFormatReader();
        
        // åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
        const videoInputDevices = await codeReader.listVideoInputDevices();
        
        // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
        selectedDeviceId = videoInputDevices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear')
        )?.deviceId || videoInputDevices[0]?.deviceId;
        
        if (!selectedDeviceId) {
          throw new Error('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        // ç¶™ç¶šçš„ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹
        await codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err) => {
          if (result) {
            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œå‡ºæˆåŠŸ
            handleBarcodeDetected(result.text);
          }
          if (err && !(err.name === 'NotFoundException')) {
            console.error('ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
          }
        });
        
        isShowingCamera = true;
        
        // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        const scanButton = document.getElementById('scanButton');
        scanButton.textContent = 'ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢';
        scanButton.classList.remove('btn-primary');
        scanButton.classList.add('btn-warning');
        
        setSidebarMessage('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„', 'info');
        
      } catch (err) {
        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
        setSidebarMessage('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error');
      }
    }
    
    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åœæ­¢
    function stopCameraPreview() {
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      
      const videoElement = document.querySelector('#interactive video');
      if (videoElement) {
        videoElement.remove();
      }
      
      isShowingCamera = false;
      
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      const scanButton = document.getElementById('scanButton');
      scanButton.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹';
      scanButton.classList.remove('btn-warning');
      scanButton.classList.add('btn-primary');
      
      // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ã‚¯ãƒªã‚¢
      const scanResult = document.getElementById('scan-result');
      scanResult.style.display = 'none';
      scanResult.textContent = '';
    }
    
    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œå‡ºæ™‚ã®å‡¦ç†
    function handleBarcodeDetected(code) {
      // ãƒ“ãƒ¼ãƒ—éŸ³ã‚’å†ç”Ÿ
      playBeepSound();
      
      // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’è¡¨ç¤º
      const scanResult = document.getElementById('scan-result');
      scanResult.textContent = 'âœ“ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º: ' + code;
      scanResult.style.display = 'block';
      
      // ISBNå…¥åŠ›æ¬„ã«å€¤ã‚’è¨­å®š
      document.getElementById('isbn').value = code;
      
      // 1ç§’å¾Œã«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      setTimeout(() => {
        closeSidebar();
        showMessage('ISBNã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ', 'success');
      }, 1000);
    }
    
    // ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿ
    function playBeepSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1000;
        gainNode.gain.value = 0.3;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        console.error("ãƒ“ãƒ¼ãƒ—éŸ³ã®å†ç”Ÿã«å¤±æ•—:", e);
      }
    }
    
    // æ‰‹å‹•å…¥åŠ›ã®ç¢ºå®š
    function submitManualInputFromSidebar() {
      const code = document.getElementById('manual-isbn-sidebar').value;
      if (!code) {
        setSidebarMessage('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // ISBNå…¥åŠ›æ¬„ã«å€¤ã‚’è¨­å®š
      document.getElementById('isbn').value = code;
      
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      closeSidebar();
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      showMessage('ISBNã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
    }
    
    // Enterã‚­ãƒ¼ã§æ‰‹å‹•å…¥åŠ›ã‚’ç¢ºå®š
    document.addEventListener('DOMContentLoaded', function() {
      const manualInput = document.getElementById('manual-isbn-sidebar');
      if (manualInput) {
        manualInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            submitManualInputFromSidebar();
          }
        });
      }
      
      // ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®èª¿æ•´
      const inputs = document.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä¸Šã«ç§»å‹•
          const buttonGroup = document.querySelector('.button-group');
          if (buttonGroup) {
            setTimeout(() => {
              const windowHeight = window.innerHeight;
              const inputRect = this.getBoundingClientRect();
              if (inputRect.bottom > windowHeight - 200) {
                window.scrollTo({
                  top: inputRect.top - 100,
                  behavior: 'smooth'
                });
              }
            }, 300);
          }
        });
      });
    });
    
    function searchByISBN() {
      const isbn = document.getElementById('isbn').value;
      if (!isbn) {
        showMessage('ISBNã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      showMessage('ISBNæ¤œç´¢ã‚’å®Ÿè¡Œä¸­...', 'info');
      
      // Google Apps Scriptã®ISBNæ¤œç´¢ã‚’å‘¼ã³å‡ºã™
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.bookInfo) {
            // æ¤œç´¢çµæœã‚’å…¥åŠ›æ¬„ã«åæ˜ 
            const bookInfo = result.bookInfo;
            if (bookInfo.title) document.getElementById('title').value = bookInfo.title;
            if (bookInfo.author) document.getElementById('author').value = bookInfo.author;
            if (bookInfo.publisher) document.getElementById('publisher').value = bookInfo.publisher;
            if (bookInfo.publishYear) document.getElementById('publishYear').value = bookInfo.publishYear;
            
            showMessage('æ›¸ç±æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æ¬¡ã®å…¥åŠ›æ¬„ã«ç§»å‹•
            const titleKanaInput = document.getElementById('titleKana');
            if (titleKanaInput) titleKanaInput.focus();
          } else {
            showMessage(result.message || 'æ›¸ç±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ISBNæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
          showMessage('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .searchBookByISBN(isbn);
    }
    
    document.getElementById('bookForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const bookData = {
        isbn: document.getElementById('isbn').value || generateISBN(),
        title: document.getElementById('title').value,
        titleKana: document.getElementById('titleKana').value,
        author: document.getElementById('author').value,
        authorKana: document.getElementById('authorKana').value,
        publisher: document.getElementById('publisher').value,
        publishYear: document.getElementById('publishYear').value,
        price: document.getElementById('price').value,
        category: document.getElementById('category').value,
        location: document.getElementById('location').value
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage(result.message, 'success');
            clearForm();
          } else {
            showMessage(result.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler(handleError)
        .registerBook(bookData);
    });
    
    function generateISBN() {
      return '978-' + Date.now().toString().slice(-10);
    }
    
    function clearForm() {
      document.getElementById('bookForm').reset();
      document.getElementById('isbn').value = '';
    }
    
    // navigateToé–¢æ•°ã‚’è¿½åŠ 
    function navigateTo(page) {
      google.script.run
        .withSuccessHandler(function(url) {
          window.top.location.href = url + '?page=' + page;
        })
        .getDeployedUrl();
    }
  </script>
</body>
</html>