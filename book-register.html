<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>書籍登録</title>
  <?!= include('common-styles'); ?>
  <style>
    #barcodeScanner {
      width: 100%;
      max-width: 400px;
      height: 300px;
      border: 2px dashed #ddd;
      margin: 10px 0;
      display: none;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>書籍登録</h1>
    
    <div id="message"></div>
    
    <div class="form-section">
      <h2>ISBN検索</h2>
      <div class="form-group">
        <label for="isbn">ISBNコード</label>
        <input type="text" id="isbn" placeholder="978-4-XXXX-XXXX-X">
        <button class="btn btn-secondary" onclick="toggleScanner()" style="margin-top: 10px;">バーコードスキャン</button>
        <div id="barcodeScanner"></div>
        <button class="btn btn-primary" onclick="searchByISBN()" style="margin-top: 10px;">ISBN検索</button>
      </div>
    </div>
    
    <form id="bookForm" class="form-section">
      <h2>書籍情報</h2>
      <div class="form-group">
        <label for="title" class="required">書籍名</label>
        <input type="text" id="title" required>
      </div>
      
      <div class="form-group">
        <label for="titleKana">書籍名ヨミ</label>
        <input type="text" id="titleKana" placeholder="ひらがなまたはカタカナ">
      </div>
      
      <div class="form-group">
        <label for="author" class="required">著者</label>
        <input type="text" id="author" required>
      </div>
      
      <div class="form-group">
        <label for="authorKana">著者ヨミ</label>
        <input type="text" id="authorKana" placeholder="ひらがなまたはカタカナ">
      </div>
      
      <div class="form-group">
        <label for="publisher" class="required">出版社</label>
        <input type="text" id="publisher" required>
      </div>
      
      <div class="form-group">
        <label for="publishYear">発行年</label>
        <input type="number" id="publishYear" min="1900" max="2100">
      </div>
      
      <div class="form-group">
        <label for="price">価格</label>
        <input type="number" id="price" min="0">
      </div>
      
      <div class="form-group">
        <label for="category">カテゴリ</label>
        <input type="text" id="category" placeholder="例: 小説、ビジネス書">
      </div>
      
      <div class="form-group">
        <label for="location">所在場所</label>
        <input type="text" id="location" placeholder="例: A-1-1">
      </div>
      
      <div class="button-group">
        <button type="submit" class="btn btn-primary">登録</button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()">クリア</button>
        <button type="button" class="btn btn-secondary" onclick="navigateTo('menu')">戻る</button>
      </div>
    </form>
  </div>
  
  <?!= include('common-scripts'); ?>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <script>
    let scannerActive = false;
    
    function toggleScanner() {
      const scanner = document.getElementById('barcodeScanner');
      if (scannerActive) {
        Quagga.stop();
        scanner.style.display = 'none';
        scannerActive = false;
      } else {
        scanner.style.display = 'block';
        initScanner();
        scannerActive = true;
      }
    }
    
    function initScanner() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#barcodeScanner')
        },
        decoder: {
          readers: ["ean_reader", "ean_13_reader"]
        }
      }, function(err) {
        if (err) {
          console.error(err);
          return;
        }
        Quagga.start();
      });
      
      Quagga.onDetected(function(result) {
        document.getElementById('isbn').value = result.codeResult.code;
        toggleScanner();
      });
    }
    
    function searchByISBN() {
      const isbn = document.getElementById('isbn').value;
      if (!isbn) {
        showMessage('ISBNを入力してください', 'error');
        return;
      }
      
      // 実際のISBN検索実装は省略
      showMessage('ISBN検索機能は実装予定です', 'info');
    }
    
    document.getElementById('bookForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const bookData = {
        isbn: document.getElementById('isbn').value || generateISBN(),
        title: document.getElementById('title').value,
        titleKana: document.getElementById('titleKana').value,
        author: document.getElementById('author').value,
        authorKana: document.getElementById('authorKana').value,
        publisher: document.getElementById('publisher').value,
        publishYear: document.getElementById('publishYear').value,
        price: document.getElementById('price').value,
        category: document.getElementById('category').value,
        location: document.getElementById('location').value
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage(result.message, 'success');
            clearForm();
          } else {
            showMessage(result.message || '登録に失敗しました', 'error');
          }
        })
        .withFailureHandler(handleError)
        .registerBook(bookData);
    });
    
    function generateISBN() {
      return '978-' + Date.now().toString().slice(-10);
    }
    
    function clearForm() {
      document.getElementById('bookForm').reset();
      document.getElementById('isbn').value = '';
    }
  </script>
</body>
</html>