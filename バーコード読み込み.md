```
// バーコード読み取りアルゴリズムの実装

// グローバル変数
let currentScannerTarget = null;  // 現在のスキャナーターゲット
let bookIdScanning = false;       // 書籍IDスキャン中フラグ
let userScanning = false;         // 利用者IDスキャン中フラグ
let currentFacingMode = "environment"; // カメラの向き（environment=背面、user=前面）

// 重複検出防止用の変数
let lastDetectedTime = 0;
let lastDetectedCode = null;
const COOLDOWN_PERIOD = 3000; // 同じコードを再検出するまでの待機時間（3秒）

/**
 * スキャナーの表示/非表示を切り替える
 * @param {string} viewportId - ビューポートのID ('interactive' or 'interactive-user')
 * @param {string} inputFieldId - 入力フィールドのID ('book-id' or 'user-id')
 */
function toggleScanner(viewportId, inputFieldId) {
    let containerId;
    if (viewportId === 'interactive') {
        containerId = 'scanner-container-book';
    } else if (viewportId === 'interactive-user') {
        containerId = 'scanner-container-user';
    }
    
    const container = document.getElementById(containerId);
    if (!container) {
        console.error('Container not found:', containerId);
        setMessage('スキャナーの初期化に失敗しました。');
        return;
    }
    
    if (container.style.display === 'none' || !container.style.display) {
        // 他のスキャナーを閉じる
        document.querySelectorAll('.scanner-container').forEach(el => {
            if (el.id !== containerId) {
                el.style.display = 'none';
                const vpId = el.querySelector('.scanner-viewport').id;
                stopScanner(vpId);
            }
        });
        
        container.style.display = 'flex';
        startScanner(viewportId, inputFieldId);
    } else {
        closeScanner(viewportId);
    }
}

/**
 * スキャナーを起動する
 * @param {string} targetElementId - ターゲット要素のID
 * @param {string} inputFieldId - 入力フィールドのID
 */
function startScanner(targetElementId, inputFieldId) {
    // 既存のQuaggaインスタンスを停止
    if (typeof Quagga !== 'undefined' && Quagga._handler) {
        Quagga.stop();
    }
    
    // ビューポートをクリア
    const viewport = document.getElementById(targetElementId);
    if (viewport) {
        viewport.innerHTML = '';
        viewport.style.cssText = '';
    }
    
    // グローバルにdrawingBufferを削除
    document.querySelectorAll('.drawingBuffer').forEach(el => el.remove());
    
    currentScannerTarget = targetElementId;
    if (targetElementId === 'interactive') bookIdScanning = true;
    else userScanning = true;
    
    // 初期化
    setTimeout(() => {
        initializeScanner(targetElementId, inputFieldId);
    }, 100);
}

/**
 * QuaggaJSを初期化してバーコードスキャンを開始する
 * @param {string} targetElementId - ターゲット要素のID
 * @param {string} inputFieldId - 入力フィールドのID
 */
function initializeScanner(targetElementId, inputFieldId) {
    // 既存のリスナーを解除
    if (typeof Quagga !== 'undefined') {
        Quagga.offDetected(null);
        Quagga.offProcessed(null);
    }
    
    // QuaggaJSの設定
    const config = {
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector(`#${targetElementId}`),
            constraints: {
                facingMode: currentFacingMode,
                width: { min: 640 },
                height: { min: 480 }
            }
        },
        locator: {
            patchSize: "medium",     // パッチサイズ（small, medium, large）
            halfSample: true         // 画像を半分にサンプリングして処理速度向上
        },
        numOfWorkers: 2,            // Web Workerの数
        frequency: 10,              // スキャン頻度
        decoder: {
            readers: targetElementId === 'interactive-user' ? 
                // 利用者IDの場合のバーコード形式
                ["code_128_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader"] : 
                // 書籍IDの場合のバーコード形式（ISBNも含む）
                ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader"]
        },
        locate: true                // バーコードの位置を自動検出
    };
    
    // Quaggaを初期化
    Quagga.init(config, function(err) {
        if (err) {
            console.error("Quagga init error:", err);
            setMessage("カメラの初期化に失敗しました");
            closeScanner(targetElementId);
            return;
        }
        
        // スキャン開始
        Quagga.start();
        
        // バーコード検出時のイベントハンドラー
        Quagga.onDetected(function(result) {
            handleBarcodeDetection(result, targetElementId, inputFieldId);
        });
    });
}

/**
 * バーコード検出時の処理
 * @param {Object} result - Quaggaの検出結果
 * @param {string} targetElementId - ターゲット要素のID
 * @param {string} inputFieldId - 入力フィールドのID
 */
function handleBarcodeDetection(result, targetElementId, inputFieldId) {
    // スキャナーが停止している場合は処理しない
    if (!currentScannerTarget || 
        (targetElementId === 'interactive' && !bookIdScanning) || 
        (targetElementId === 'interactive-user' && !userScanning)) {
        console.log("スキャナーは既に停止しています。イベントを無視します。");
        return;
    }
    
    const code = result.codeResult.code;
    const currentTime = new Date().getTime();
    const confidence = result.codeResult.confidence;
    
    console.log("バーコード検出:", code, "信頼度:", confidence);
    
    // 信頼度チェック（0.5以上を採用）
    if (confidence < 0.5) {
        console.log("信頼度が低いため無視します:", confidence);
        return;
    }
    
    // 重複検出の防止
    if (code === lastDetectedCode && (currentTime - lastDetectedTime) < COOLDOWN_PERIOD) {
        console.log(`同じコードが短時間で検出されました。無視します。経過時間: ${currentTime - lastDetectedTime}ms`);
        return;
    }
    
    // 検出成功処理
    lastDetectedCode = code;
    lastDetectedTime = currentTime;
    
    // ビープ音を再生
    playBeepSound();
    
    // スキャナーを閉じる
    closeScanner(targetElementId);
    
    // フィールドに応じた後続処理
    if (inputFieldId === 'book-id') {
        bookIdScanning = false;
        addBookToList(code); // 書籍IDをリストに追加
    } else if (inputFieldId === 'user-id') {
        userScanning = false;
        document.getElementById(inputFieldId).value = code;
        setMessage(`利用者ID「${code}」を読み取りました。`);
        fetchUserInfo(code); // 利用者情報を取得
    }
}

/**
 * カメラを切り替える（前面/背面）
 * @param {string} viewportId - ビューポートのID
 */
function switchCamera(viewportId) {
    // カメラの向きを切り替え
    currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
    
    // 現在のスキャナーを停止
    stopScanner(viewportId);
    
    // 入力フィールドIDを取得
    let inputFieldId;
    if (viewportId === 'interactive') {
        inputFieldId = 'book-id';
    } else if (viewportId === 'interactive-user') {
        inputFieldId = 'user-id';
    }
    
    // 新しいカメラ設定でスキャナーを再起動
    setTimeout(() => {
        startScanner(viewportId, inputFieldId);
    }, 300);
}

/**
 * スキャナーを閉じる
 * @param {string} viewportId - ビューポートのID
 */
function closeScanner(viewportId) {
    let containerId;
    if (viewportId === 'interactive') {
        containerId = 'scanner-container-book';
    } else if (viewportId === 'interactive-user') {
        containerId = 'scanner-container-user';
    }
    
    const container = document.getElementById(containerId);
    if (container) {
        container.style.display = 'none';
    }
    
    stopScanner(viewportId);
}

/**
 * スキャナーを完全に停止する
 * @param {string} viewportId - ビューポートのID
 */
function stopScanner(viewportId) {
    // Quaggaが初期化されているかチェック
    if (typeof Quagga !== 'undefined' && Quagga._handler && Quagga._handler.inputStream) {
        try {
            // イベントハンドラーをクリア
            Quagga.offProcessed();
            Quagga.offDetected();
            Quagga.stop();
        } catch (e) {
            console.error("Quagga stop error:", e);
        }
    }
    
    // ビューポートを完全にクリア
    const viewport = document.getElementById(viewportId);
    if (viewport) {
        // すべての子要素を削除
        while (viewport.firstChild) {
            viewport.removeChild(viewport.firstChild);
        }
        
        // スタイルをリセット
        viewport.removeAttribute('style');
        viewport.style.display = 'none';
        
        // Quaggaが生成した要素を削除
        document.querySelectorAll('.drawingBuffer').forEach(el => el.remove());
    }
    
    // スキャナーコンテナ内のcanvas/video要素を削除
    const container = document.getElementById('scanner-container-' + 
        (viewportId === 'interactive' ? 'book' : viewportId.includes('user') ? 'user' : viewportId));
    if (container) {
        container.querySelectorAll('canvas').forEach(el => el.remove());
        container.querySelectorAll('video').forEach(el => el.remove());
    }
    
    // スキャン状態をリセット
    if (viewportId && viewportId.includes('user')) {
        userScanning = false;
    } else {
        bookIdScanning = false;
    }
    currentScannerTarget = null;
}

/**
 * ビープ音を再生する
 */
function playBeepSound() {
    try {
        // Web Audio APIを使用してビープ音を生成
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1000; // 1000Hzのビープ音
        gainNode.gain.value = 0.3;         // 音量
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1); // 0.1秒間再生
    } catch (e) {
        console.error("ビープ音の再生に失敗:", e);
    }
}

/**
 * バーコード検証アルゴリズム
 * @param {string} barcode - バーコード文字列
 * @param {string} type - バーコードタイプ（'book' or 'user'）
 * @returns {boolean} - 有効なバーコードかどうか
 */
function validateBarcode(barcode, type) {
    if (!barcode || typeof barcode !== 'string') {
        return false;
    }
    
    if (type === 'book') {
        // 書籍ID: B0001形式またはISBN（10桁/13桁）
        const bookIdPattern = /^B\d{4}$/;
        const isbn10Pattern = /^\d{10}$/;
        const isbn13Pattern = /^\d{13}$/;
        
        return bookIdPattern.test(barcode) || 
               isbn10Pattern.test(barcode) || 
               isbn13Pattern.test(barcode);
    } else if (type === 'user') {
        // 利用者ID: U0001形式
        const userIdPattern = /^U\d{4}$/;
        return userIdPattern.test(barcode);
    }
    
    return false;
}

/**
 * ISBN-13のチェックデジット検証
 * @param {string} isbn - ISBN-13文字列
 * @returns {boolean} - 有効なISBN-13かどうか
 */
function validateISBN13(isbn) {
    if (!/^\d{13}$/.test(isbn)) {
        return false;
    }
    
    let sum = 0;
    for (let i = 0; i < 12; i++) {
        sum += parseInt(isbn[i]) * (i % 2 === 0 ? 1 : 3);
    }
    
    const checkDigit = (10 - (sum % 10)) % 10;
    return checkDigit === parseInt(isbn[12]);
}

/**
 * ISBN-10のチェックデジット検証
 * @param {string} isbn - ISBN-10文字列
 * @returns {boolean} - 有効なISBN-10かどうか
 */
function validateISBN10(isbn) {
    if (!/^\d{9}[\dX]$/.test(isbn)) {
        return false;
    }
    
    let sum = 0;
    for (let i = 0; i < 9; i++) {
        sum += parseInt(isbn[i]) * (10 - i);
    }
    
    const lastChar = isbn[9];
    const checkDigit = lastChar === 'X' ? 10 : parseInt(lastChar);
    sum += checkDigit;
    
    return sum % 11 === 0;
}
```